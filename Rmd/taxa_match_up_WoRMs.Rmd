---
title: "Taxonomix Matchup to WoRMs"
author: "Sebastian DiGeronimo"
date: "3/2/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library("readxl")
library("hablar") # might be useful when needing to fix names
library("worrms")

library("tidyverse")
library("ggplot2")
library("ggforce")
library("tibble")
library("tidyr")
library("readr")
library("purrr")
library("dplyr")
library("stringr")
library("forcats")
library("lubridate")
library("glue")
library("fs")
library("geosphere")
library("vroom")
library("plotly")
library("magrittr")

```

```{r load-functions}
# # source scripts with functions in new environment
# my_funcs <- new.env()
# 
# # create directory structure if does not exists and create tree map
# source(here::here("scripts","create_dir.R"), local = my_funcs)
# # copy files from box
# source(here::here("scripts", "copy_files_from_box.R"), local = my_funcs)
# # loading check for taxa 
# source(here::here("scripts", "taxa_list_check.R"), local = my_funcs)
# 
# 
# attach(my_funcs)
```

```{r load-taxa-data}
# ---- load data set ----
file.taxa <- 
    fs::dir_ls(path =  here::here("data", "raw"),
           regexp = "^[^~]*\\.xlsx$",
           recurse = TRUE) %>%
           skip_file(.)

taxa_data <-
    file.taxa %>%
    map_dfr(., ~ load_data(.x), .id = "Files") %>%
    mutate(Files = basename(Files))
taxa_data
```

1. read in new occurrence file
2. read the first 10 rows and transpose to longer
3. determine if the identified species are in the master aphia taxa list, or 
    if need to rerun taxa_match_fix
4. row bind occurrence data with taxa info

```{r}
# TODO: read in all files, joining with scientific names, then add more if they 
# don't exist
taxa_matched_merg <- merge_taxa(taxa_data, check = FALSE) %>%
    relocate(Files, cruise_id, date_collected, site, .before = 1) %>%
    arrange(date_collected, site, taxa)

save_merged(taxa_matched_merg, 
            file.taxa
            )
```

# tried a different database without working
```{r}
# library("taxize")
# 
# 
# 
# cbind(taxa.name, test)
# 
# ?get_tsn
# get_tsn(taxa.name[1:5])
# get_tsn(("Acartia"))
# get_wormsid(test)
# get_wormsid("fish", searchtype = 'common')
# 
# rgbif::name_backbone("Acartia")
# 
# obistools::match_taxa(c("Acartia","Candacia","copepod","Euterpina acuntifrons"), ask = T)
```

```{r}


# obis.taxa <- obistools::match_taxa(taxa.name, ask = T)
# 
# robis::taxon(11676)
# 
# # with this 20 have NA without ability to ask for input
# obis.taxa %>%
#     mutate(taxa.name, .before = 1)
```

